<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WhatsApp Bot + Gemini AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; padding: 24px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .hidden { display: none; }
        .center-text { text-align: center; }
        h1, h2, h3 { color: #1c1e21; }
        h3 { border-top: 1px solid #dddfe2; padding-top: 20px; margin-top: 20px;}
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccd0d5; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #1877f2; color: white; cursor: pointer; border-color: #1877f2; font-weight: bold; }
        button:hover { background-color: #166fe5; }
        .back-btn { background-color: #6c757d; border-color: #6c757d; width: auto; padding: 8px 15px; margin-bottom: 20px;}
        .device-list-item { display: grid; grid-template-columns: 1fr auto; padding: 15px; border-bottom: 1px solid #dddfe2; gap: 15px; align-items: center;}
        .device-list-item .actions { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .device-list-item .actions button { width: auto; margin: 0; font-size: 14px; padding: 8px 12px; }
        .disconnect-btn, .delete-btn { background-color: #fa3e3e; border-color: #fa3e3e; }
        .status { padding: 4px 8px; border-radius: 12px; font-weight: bold; color: white; font-size: 12px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #6c757d; }
        .status-needs-qr-scan { background-color: #ffc107; color: black; }
        .status-initializing, .status-failed { background-color: #17a2b8; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="container" id="view-root">
        <!-- Views will be rendered here by JavaScript -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const fetchOptions = { credentials: 'include' };
            const root = document.getElementById('view-root');

            const app = {
                // --- Handlers for all actions ---
                handleLogin: async () => {
                    const username = root.querySelector('#username').value;
                    const password = root.querySelector('#password').value;
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                        ...fetchOptions
                    });
                    if (response.ok) app.renderDashboard();
                    else alert('Login Failed!');
                },
                handleLogout: async () => {
                    await fetch('/logout', fetchOptions);
                    location.reload();
                },
                handleAddDevice: () => {
                    const clientIdInput = root.querySelector('#new-client-id');
                    const clientId = clientIdInput.value.trim().replace(/\s+/g, '_');
                    if (clientId) {
                        socket.emit('add-device', { clientId });
                        clientIdInput.value = '';
                    } else {
                        alert('Please enter a device name.');
                    }
                },
                handleDisconnect: async (clientId) => {
                    if (confirm(`Are you sure you want to disconnect ${clientId}?`)) {
                        await fetch(`/api/disconnect/${clientId}`, { method: 'POST', ...fetchOptions });
                    }
                },
                handleGeminiToggle: async (clientId, isEnabled) => {
                    await fetch(`/api/toggle-gemini/${clientId}`, { method: 'POST', ...fetchOptions });
                    const statusBox = root.querySelector('#status-box');
                    if(statusBox) statusBox.textContent = `Gemini AI ${isEnabled ? 'enabled' : 'disabled'} for ${clientId}.`;
                },
                handleSaveKeyword: async (clientId) => {
                    const keyword = root.querySelector('#keyword-input').value.trim();
                    const reply = root.querySelector('#reply-input').value.trim();
                    const match_type = root.querySelector('#match-type-select').value;
                    if (!keyword || !reply) return alert('Keyword and Reply fields are required.');
                    await fetch(`/api/keywords/${clientId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ keyword, reply, match_type }),
                        ...fetchOptions
                    });
                    app.renderKeywordsManager(clientId);
                },
                handleDeleteKeyword: async (clientId, keywordId) => {
                    if (confirm('Are you sure you want to delete this keyword?')) {
                         await fetch(`/api/keywords/${clientId}/${keywordId}`, { method: 'DELETE', ...fetchOptions });
                         app.renderKeywordsManager(clientId);
                    }
                },

                // --- View Rendering Functions ---
                renderLogin: () => {
                    root.innerHTML = `
                        <div class="center-text">
                            <h1>Login to Bot Panel</h1>
                            <input type="text" id="username" placeholder="Username" value="admin">
                            <input type="password" id="password" placeholder="Password" value="password123">
                            <button id="login-btn">Login</button>
                        </div>`;
                },
                renderDashboard: async () => {
                    root.innerHTML = `
                        <button id="logout-btn" style="float:right;">Logout</button>
                        <h1>Device Dashboard</h1>
                        <div id="status-box" class="center-text">Welcome! Add a new device or manage existing ones.</div>
                        <h3>Add New Device</h3>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="new-client-id" placeholder="Enter a unique name (e.g., support_bot)">
                            <button id="add-device-btn">Add Device</button>
                        </div>
                        <h3>Existing Devices</h3>
                        <div id="device-list">Loading...</div>`;
                    try {
                        const response = await fetch('/api/devices', fetchOptions);
                        const devices = await response.json();
                        const deviceList = root.querySelector('#device-list');
                        deviceList.innerHTML = devices.length ? '' : '<p class="center-text">No devices found.</p>';
                        devices.forEach(device => {
                            const el = document.createElement('div');
                            el.className = 'device-list-item';
                            el.id = `device-${device.id}`;
                            el.innerHTML = `
                                <div>
                                    <strong>${device.id}</strong><br>
                                    <span class="status status-${device.status.toLowerCase().replace(/ /g, '-')}">${device.status}</span>
                                </div>
                                <div class="actions">
                                    <label style="display:flex; align-items:center; gap:5px; cursor:pointer; font-weight:normal; font-size:14px;">
                                        <span>Gemini AI</span>
                                        <div class="switch">
                                            <input type="checkbox" class="gemini-toggle" data-id="${device.id}" ${device.geminiEnabled ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </div>
                                    </label>
                                    <button class="manage-keywords-btn" data-id="${device.id}">Keywords</button>
                                    ${device.status === 'Connected' ? `<button class="disconnect-btn" data-id="${device.id}">Disconnect</button>` : ''}
                                </div>`;
                            deviceList.appendChild(el);
                        });
                    } catch (error) {
                         root.querySelector('#device-list').innerHTML = `<p style="color:red;" class="center-text">Could not load devices.</p>`;
                    }
                },
                renderKeywordsManager: async (clientId) => {
                    root.innerHTML = `
                        <button class="back-to-dash"> ← Back to Dashboard</button>
                        <h2>Manage Keywords for: <strong>${clientId}</strong></h2>
                        <div style="border: 1px solid #eee; padding: 15px; margin-top:20px;">
                             <h3>Add New Keyword</h3>
                             <input type="text" id="keyword-input" placeholder="Keyword or Phrase">
                             <input type="text" id="reply-input" placeholder="Bot's Reply Message">
                             <select id="match-type-select"><option value="exact">Exact Match</option><option value="contains">Contains Match</option></select>
                             <button id="save-keyword-btn" data-clientid="${clientId}">Save Keyword</button>
                        </div>
                        <h3>Saved Keywords</h3><div id="keywords-list">Loading...</div>`;
                    try {
                        const response = await fetch(`/api/keywords/${clientId}`, fetchOptions);
                        const keywords = await response.json();
                        const keywordsList = root.querySelector('#keywords-list');
                        keywordsList.innerHTML = keywords.length ? '' : '<p class="center-text">No keywords defined for this device.</p>';
                        keywords.forEach(k => {
                            const item = document.createElement('div');
                            item.className = 'keyword-item';
                            item.innerHTML = `
                                <span><strong>Keyword:</strong><br>${k.keyword}</span>
                                <span><strong>Reply:</strong><br>${k.reply} (${k.match_type})</span>
                                <div class="actions">
                                    <button class="delete-btn delete-keyword-btn" data-clientid="${clientId}" data-keywordid="${k.id}">Delete</button>
                                </div>`;
                            keywordsList.appendChild(item);
                        });
                    } catch (error) {
                        root.querySelector('#keywords-list').innerHTML = `<p style="color:red;" class="center-text">Could not load keywords.</p>`;
                    }
                },
                renderQR: (clientId, url) => {
                    root.innerHTML = `
                        <div class="center-text">
                            <h2>Scan QR for: <strong>${clientId}</strong></h2>
                            <img id="qrcode-image" src="${url}">
                            <button class="back-to-dash">Back to Dashboard</button>
                        </div>`;
                },

                // --- Initializer ---
                init: async () => {
                    // --- Event Delegation ---
                    root.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.id === 'login-btn') app.handleLogin();
                        if (target.id === 'logout-btn') app.handleLogout();
                        if (target.id === 'add-device-btn') app.handleAddDevice();
                        if (target.matches('.back-to-dash')) app.renderDashboard();
                        if (target.matches('.disconnect-btn')) app.handleDisconnect(target.dataset.id);
                        if (target.matches('.manage-keywords-btn')) app.renderKeywordsManager(target.dataset.id);
                        if (target.id === 'save-keyword-btn') app.handleSaveKeyword(target.dataset.clientid);
                        if (target.matches('.delete-keyword-btn')) app.handleDeleteKeyword(target.dataset.clientid, target.dataset.keywordid);
                    });
                     root.addEventListener('change', e => {
                        if (e.target.matches('.gemini-toggle')) {
                            app.handleGeminiToggle(e.target.dataset.id, e.target.checked);
                        }
                    });

                    // --- Socket Listeners ---
                    socket.on('statusUpdate', () => { if(root.querySelector('#device-list')) app.renderDashboard(); });
                    socket.on('qr', ({ clientId, url }) => app.renderQR(clientId, url));
                    socket.on('ready', ({ clientId }) => { alert(`Device '${clientId}' is connected!`); if(root.querySelector('#device-list')) app.renderDashboard(); });

                    // --- Initial Page Load ---
                    try {
                        const response = await fetch('/api/auth-status', fetchOptions);
                        const data = await response.json();
                        data.loggedIn ? app.renderDashboard() : app.renderLogin();
                    } catch (e) {
                        app.renderLogin();
                    }
                }
            };

            // Start the application
            app.init();
        });
    </script>
</body>
</html>
