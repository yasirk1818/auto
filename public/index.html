<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WhatsApp Bot - Ultimate Panel</title>
    <!-- ... (Saare styles pehle jaise hi) ... -->
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; padding: 24px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .hidden { display: none; }
        .center-text { text-align: center; }
        h1, h2, h3 { color: #1c1e21; }
        h3 { border-top: 1px solid #dddfe2; padding-top: 20px; margin-top: 20px;}
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccd0d5; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #1877f2; color: white; cursor: pointer; border-color: #1877f2; font-weight: bold; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .device-list-item { display: grid; grid-template-columns: 1fr auto; padding: 15px; border-bottom: 1px solid #dddfe2; gap: 15px; align-items: center;}
        .device-list-item .actions { display: flex; align-items: center; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        .actions button { width: auto; margin: 0; font-size: 14px; padding: 8px 12px; }
        .status { padding: 4px 8px; border-radius: 12px; font-weight: bold; color: white; font-size: 12px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #6c757d; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="container" id="view-root"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const fetchOptions = { credentials: 'include' };
            const root = document.getElementById('view-root');

            const app = {
                init: () => {
                    root.addEventListener('click', (e) => {
                        const target = e.target;
                        if (target.id === 'login-btn') app.handleLogin();
                        if (target.id === 'logout-btn') app.handleLogout();
                        if (target.matches('.back-to-dash')) app.renderDashboard();
                        if (target.id === 'add-device-btn') app.handleAddDevice();
                        if (target.matches('.disconnect-btn')) app.handleDisconnect(target.dataset.id);
                        if (target.matches('.manage-keywords-btn')) app.renderKeywordsManager(target.dataset.id);
                        if (target.matches('.global-settings-btn')) app.renderGlobalSettings(); // NAYA
                        if (target.id === 'save-settings-btn') app.handleSaveSettings(); // NAYA
                        // ... baaki ke click handlers
                    });
                    root.addEventListener('change', e => {
                        if (e.target.matches('.gemini-toggle')) app.handleGeminiToggle(e.target.dataset.id, e.target.checked);
                        if (e.target.matches('.auto-read-toggle')) app.handleAutoReadToggle(e.target.dataset.id, e.target.checked);
                    });
                    // Socket listeners...
                    app.checkAuthStatus();
                },

                // Handlers...
                handleLogin: async () => { /* ... */ },
                handleLogout: async () => { /* ... */ },
                handleGeminiToggle: async (clientId, isEnabled) => { /* ... */ },
                // NAYA: Save Global Settings
                handleSaveSettings: async () => {
                    const apiKey = root.querySelector('#gemini-api-key').value.trim();
                    const modelName = root.querySelector('#gemini-model-name').value.trim();
                    await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ geminiApiKey: apiKey, geminiModelName: modelName }),
                        ...fetchOptions
                    });
                    alert('Settings Saved!');
                    app.renderDashboard();
                },
                
                // Render Functions...
                renderDashboard: async () => {
                    root.innerHTML = `
                        <button id="logout-btn" class="btn-danger" style="float:right;">Logout</button>
                        <button class="global-settings-btn btn-secondary" style="float:right; margin-right: 10px;">Global Settings</button>
                        <h1>Device Dashboard</h1>
                        <!-- ... (dashboard ka baaki ka HTML) ... -->
                    `;
                    // ... (dashboard ki baaki ki logic)
                },
                // NAYA: Render Global Settings View
                renderGlobalSettings: async () => {
                    root.innerHTML = `
                        <button class="back-to-dash"> ‚Üê Back to Dashboard</button>
                        <h2>Global Settings</h2>
                        <h3>Gemini AI Configuration</h3>
                        <p>Changes here will affect all devices where Gemini AI is enabled.</p>
                        <input type="password" id="gemini-api-key" placeholder="Enter New Gemini API Key (optional)">
                        <input type="text" id="gemini-model-name" placeholder="gemini-1.0-pro">
                        <button id="save-settings-btn">Save Settings</button>`;
                    
                    const response = await fetch('/api/settings', fetchOptions);
                    const settings = await response.json();
                    root.querySelector('#gemini-api-key').placeholder = `Current: ${settings.geminiApiKey}`;
                    root.querySelector('#gemini-model-name').value = settings.geminiModelName;
                },
                // ... (baaki ke render functions)
            };
            app.init();
        });
    </script>
</body>
</html>
